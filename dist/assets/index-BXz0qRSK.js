import{_ as K,P as H,c as R,b as u,t as C,f as l,X as P,z as L,r as s,R as I,o as W}from"./index-DUL14BUD.js";const Q={class:"recognition-container"},V=["disabled"],x={class:"result-display"},U={class:"result-content"},j={key:0,class:"error-message"},Y={__name:"index",setup(F){const B=v=>{const a=s("CLOSED"),m=s(""),n=s(null),t=s(null),i=s(null),c=s(null),d=s(null),r=s(0),y=3,w=()=>Math.random().toString(36).substr(2,8),D=async()=>{try{const e=new URL("data:text/javascript;base64,Y2xhc3MgQXVkaW9Qcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3Igew0KICAgIHByb2Nlc3MoaW5wdXRzKSB7DQogICAgICAgIGlmICghaW5wdXRzWzBdPy5bMF0pIHJldHVybiB0cnVlOw0KDQogICAgICAgIGNvbnN0IGlucHV0ID0gaW5wdXRzWzBdWzBdOw0KICAgICAgICBjb25zdCBidWZmZXIgPSBuZXcgSW50MTZBcnJheShpbnB1dC5sZW5ndGgpOw0KDQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGNvbnN0IHMgPSBNYXRoLm1heCgtMSwgTWF0aC5taW4oMSwgaW5wdXRbaV0pKTsNCiAgICAgICAgICAgIGJ1ZmZlcltpXSA9IHMgPCAwID8gcyAqIDB4ODAwMCA6IHMgKiAweDdmZmY7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2Uoew0KICAgICAgICAgICAgdHlwZTogJ2F1ZGlvJywNCiAgICAgICAgICAgIGRhdGE6IGJ1ZmZlci5idWZmZXINCiAgICAgICAgfSwgW2J1ZmZlci5idWZmZXJdKTsNCg0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQp9DQoNCnJlZ2lzdGVyUHJvY2Vzc29yKCdhdWRpby1wcm9jZXNzb3InLCBBdWRpb1Byb2Nlc3Nvcik7",import.meta.url).href;await c.value.audioWorklet.addModule(e)}catch(e){throw console.error("加载AudioWorklet失败:",e),new Error("音频处理初始化失败")}},X=async()=>{try{i.value=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}}),c.value=new AudioContext({sampleRate:16e3}),await D();const e=c.value.createMediaStreamSource(i.value);d.value=new AudioWorkletNode(c.value,"audio-processor"),e.connect(d.value),d.value.port.onmessage=o=>{a.value==="OPEN"&&t.value?.readyState===WebSocket.OPEN&&t.value.send(o.data.data)}}catch(e){throw new Error(`录音初始化失败: ${e.message}`)}},T=e=>{console.log("处理消息中");try{const o=JSON.parse(e.data);switch(console.log(o),o.type){case"MID_TEXT":m.value=o.result||"";break;case"HEARTBEAT":break;case"ERROR":n.value=`识别错误: ${o.message}`,h();break}}catch(o){console.error("消息解析错误:",o)}},g=()=>{t.value&&![WebSocket.CLOSED,WebSocket.CLOSING].includes(t.value.readyState)&&t.value.close(),i.value&&i.value.getTracks().forEach(e=>e.stop()),c.value&&c.value.state!=="closed"&&c.value.close(),d.value=null,a.value="CLOSED"},S=async()=>{if(!(a.value!=="CLOSED"&&r.value>=y))try{a.value="CONNECTING",n.value=null,t.value=new WebSocket(`wss://vop.baidu.com/realtime_asr?sn=${w()}`),t.value.onopen=async()=>{try{await X(),t.value.send(JSON.stringify({type:"START",data:{appid:v.appid,appkey:v.appkey,dev_pid:15372,cuid:w(),format:"pcm",sample:16e3}})),a.value="OPEN",r.value=0,console.log("WebSocket connected")}catch(e){n.value=e.message,t.value.close()}},t.value.onmessage=T,t.value.onerror=()=>{n.value="连接错误，正在重试...",g(),b()},t.value.onclose=()=>g()}catch(e){n.value=e.message,b()}},b=()=>{r.value<y?(r.value++,setTimeout(S,1e3*r.value)):(n.value="超过最大重试次数",g())},h=()=>{if(a.value==="OPEN"){a.value="CLOSING";try{t.value?.readyState===WebSocket.OPEN&&t.value.send(JSON.stringify({type:"END"}))}finally{g()}}},M=I(()=>a.value==="OPEN"),z=I(()=>a.value==="CONNECTING"),J=I(()=>{switch(a.value){case"CONNECTING":return"连接中...";case"OPEN":return"录音中";case"CLOSING":return"正在停止";default:return"准备就绪"}});return{status:a,result:m,error:n,isRecording:M,isConnecting:z,statusDisplay:J,startRecognition:S,stopRecognition:h}},Z={appid:118270267,appkey:"BGXhWKtfsQhycN8SwNw35lhO"},{status:O,result:k,error:p,isRecording:A,isConnecting:E,statusDisplay:f,startRecognition:_,stopRecognition:N}=B(Z),G=()=>{A.value?N():_()};return H(()=>{N()}),(v,a)=>(W(),R("div",Q,[u("button",{onClick:G,disabled:l(E)},C(l(A)?"停止录音":"开始录音"),9,V),u("div",{class:P(["status-indicator",l(O).toLowerCase()])},C(l(f)),3),u("div",x,[a[0]||(a[0]=u("h3",null,"识别结果：",-1)),u("div",U,C(l(k)),1)]),l(p)?(W(),R("div",j,C(l(p)),1)):L("",!0)]))}},q=K(Y,[["__scopeId","data-v-9a6aefc1"]]);export{q as default};
