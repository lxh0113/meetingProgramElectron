import{i as x}from"./index-DUL14BUD.js";const D=""+new URL("loading-J8NFI_iP.gif",import.meta.url).href;async function I(r,n){const t=r.getReader();let e;for(;!(e=await t.read()).done;)n(e.value)}function L(r){let n,t,e,i=!1;return function(a){n===void 0?(n=a,t=0,e=-1):n=N(n,a);const o=n.length;let s=0;for(;t<o;){i&&(n[t]===10&&(s=++t),i=!1);let c=-1;for(;t<o&&c===-1;++t)switch(n[t]){case 58:e===-1&&(e=t-s);break;case 13:i=!0;case 10:c=t;break}if(c===-1)break;r(n.subarray(s,c),e),s=t,e=-1}s===o?n=void 0:s!==0&&(n=n.subarray(s),t-=s)}}function C(r,n,t){let e=S();const i=new TextDecoder;return function(a,o){if(a.length===0)t?.(e),e=S();else if(o>0){const s=i.decode(a.subarray(0,o)),c=o+(a[o+1]===32?2:1),l=i.decode(a.subarray(c));switch(s){case"data":e.data=e.data?e.data+`
`+l:l;break;case"event":e.event=l;break;case"id":r(e.id=l);break;case"retry":const f=parseInt(l,10);isNaN(f)||n(e.retry=f);break}}}}function N(r,n){const t=new Uint8Array(r.length+n.length);return t.set(r),t.set(n,r.length),t}function S(){return{data:"",event:"",id:"",retry:void 0}}var P=function(r,n){var t={};for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&n.indexOf(e)<0&&(t[e]=r[e]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,e=Object.getOwnPropertySymbols(r);i<e.length;i++)n.indexOf(e[i])<0&&Object.prototype.propertyIsEnumerable.call(r,e[i])&&(t[e[i]]=r[e[i]]);return t};const m="text/event-stream",R=1e3,T="last-event-id";function W(r,n){var{signal:t,headers:e,onopen:i,onmessage:u,onclose:a,onerror:o,openWhenHidden:s,fetch:c}=n,l=P(n,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((f,j)=>{const p=Object.assign({},e);p.accept||(p.accept=m);let y;function O(){y.abort(),document.hidden||v()}s||document.addEventListener("visibilitychange",O);let E=R,b=0;function g(){document.removeEventListener("visibilitychange",O),window.clearTimeout(b),y.abort()}t?.addEventListener("abort",()=>{g(),f()});const k=c??window.fetch,_=i??A;async function v(){var w;y=new AbortController;try{const h=await k(r,Object.assign(Object.assign({},l),{headers:p,signal:y.signal}));await _(h),await I(h.body,L(C(d=>{d?p[T]=d:delete p[T]},d=>{E=d},u))),a?.(),g(),f()}catch(h){if(!y.signal.aborted)try{const d=(w=o?.(h))!==null&&w!==void 0?w:E;window.clearTimeout(b),b=window.setTimeout(v,d)}catch(d){g(),j(d)}}}v()})}function A(r){const n=r.headers.get("content-type");if(!n?.startsWith(m))throw new Error(`Expected content-type to be ${m}, Actual: ${n}`)}class F{async connect(n,t,e,i,u,a){return await W(n,{method:t,headers:{"Content-Type":"application/json;charset=utf-8",...u},body:JSON.stringify(e),openWhenHidden:!0,async onopen(){},onmessage(o){i(o)},onerror(o){x.error("SSE连接出错: "+o)},onclose(){a&&a()}})}}export{F as S,D as _};
